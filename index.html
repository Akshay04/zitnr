<!DOCTYPE html>
<html>
<head>
  <title>zitnr</title>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css">
  <link rel="icon" type="image/png" href="favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" crossorigin></script>

  <style>
    a,
    span {
      font-size: 18px;
    }

    menu,
    a {
      font-size: 15px;
    }
  </style>
</head>

<body>
  <br />

  <div id="root"></div>
  <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5M4VMuWCj1CTwbcRt7uRGjghvIHWWJkg",
      authDomain: "zitnr-f1493.firebaseapp.com",
      projectId: "zitnr-f1493",
      storageBucket: "zitnr-f1493.appspot.com",
      messagingSenderId: "761238336755",
      appId: "1:761238336755:web:bc5d77b195a07ed2b47386"
    };

    window.firebaseApp = firebase.initializeApp(firebaseConfig);
  </script>


  <script type="text/babel" data-presets="react,stage-3">
    const updateQueryStringParameter = (key, val) => {
      const uri = new URL(window.location.href);
      uri.searchParams.set(key, val);
      window.history.replaceState({}, "Zitnr", uri.href);
    };

    const classnames = (args) => {
      return args.map((arg) => {
        if (typeof arg == "string") {
          return arg;
        } else {
          return Object.keys(arg).map((key) => {
            if (arg[key]) {
              return key;
            } else {
              return "";
            }
          }).join(" ");
        }
      }).join(" ");
    };

    const Menu = ({ selectedMenuItem, setSelectedMenuItem }) => {
      return (
        <div className="ui container">
          <div className="ui secondary pointing menu">
            <a href="#zitnr" className={classnames(["header", { active: selectedMenuItem == "#zitnr" }, "item"])} onClick={() => { setSelectedMenuItem("#zitnr") }}>
              zitnr
            </a>

            <div className="right menu">
              <a href="#calendar" className={classnames(["header", { active: selectedMenuItem == "#calendar" }, "item"])} onClick={() => { setSelectedMenuItem("#calendar") }}>
                calendar
              </a>
              <a href="#reservations" className={classnames(["header", { active: selectedMenuItem == "#reservations" }, "item"])} onClick={() => { setSelectedMenuItem("#reservations") }}>
                reservations
              </a>
              <a href="#donate" className={classnames(["header", { active: selectedMenuItem == "#donate" }, "item"])} onClick={() => { setSelectedMenuItem("#donate") }}>
                beer
              </a>
            </div>
          </div>
          {(() => {
            if (selectedMenuItem == "#calendar") {
              return <CalendarTab />;
            } else if (selectedMenuItem == "#reservations") {
              return <TransactionsTab />;
            } else if (selectedMenuItem == "#donate") {
              return <DonateTab />
            } else {
              return <ZitnrTab />;
            }
          })()}
        </div>
      )
    }

    const ZitnrTab = () => {
      return <div className="ui basic segment">
        <span>
          Welcome to Zitnr! <br /><br />Our project aims to enhance your pickleball experience at Miller Park in Seattle. We do this by reserving courts for open play during peak hours and providing reservations information. If you find this service helpful, please consider supporting us with a donation so we can continue to secure court access for everyone.
        </span>
      </div>
    };

    const CalendarTab = () => {
      const millerParkId = "1374";
      const params = new URL(window.location.href).searchParams;
      const [isLoading, setIsLoading] = React.useState(true);
      const [date, setDate] = React.useState(params.get("date") || moment().format("YYYY-MM-DD"));
      const [park, setPark] = React.useState(params.get("parkId") || millerParkId);
      const [unreservedData, setUnreservedData] = React.useState({});
      const [securedData, setSecuredData] = React.useState({});

      React.useEffect(() => {
        const db = window.firebaseApp.firestore();
        const unreservedDocRef = db.collection("unreserved").doc(`${park}-${date}`);
        const securedDocRef = db.collection("secured").doc(`${park}-${date}`);

        const promise1 = unreservedDocRef.get().then((doc) => {
          if (doc.exists) {
            setUnreservedData(doc.data());
          } else {
            setUnreservedData({ times: [] })
          }
        });

        const promise2 = securedDocRef.get().then((doc) => {
          if (doc.exists) {
            setSecuredData(doc.data());
          } else {
            setSecuredData({ times: [] })
          }
        });

        Promise.all([promise1, promise2]).then(() => {
          setIsLoading(false);
        });
      }, [date, park]);

      const timeFormat = "LT";

      const calendar = React.useMemo(() => {
        const entries = [];

        const seen = {};

        if (unreservedData.times) {
          unreservedData.times.forEach((time) => {
            if (seen[time.startTime]) {
              return;
            }
            seen[time.startTime] = true;

            entries.push({
              icon: "green check",
              description: "not reserved",
              startTime: moment(`${date} ${time.startTime}`).format(timeFormat),
              endTime: moment(`${date} ${time.endTime}`).format(timeFormat),
              sortKey: moment(`${date} ${time.startTime}`).format("HH:mm"),
            })
          });
        }

        if (securedData.times) {
          securedData.times.forEach((time) => {
            if (seen[time.startTime]) {
              return;
            }
            seen[time.startTime] = true;

            entries.push({
              icon: "green check",
              description: "reserved for open play - zitnr",
              startTime: moment(`${date} ${time.startTime}`).format(timeFormat),
              endTime: moment(`${date} ${time.endTime}`).format(timeFormat),
              sortKey: moment(`${date} ${time.startTime}`).format("HH:mm"),
            })
          })
        }

        const dayOfWeek = moment(date).day();
        if (park == millerParkId && (dayOfWeek == 1 || dayOfWeek == 3 || dayOfWeek == 5)) {
          entries.push({
            icon: "green check",
            description: "city drop-in hours",
            startTime: "10:00 AM",
            endTime: "12:00 PM",
            sortKey: "10:00",
          })
        }

        entries.sort((a, b) => {
          if (a.sortKey < b.sortKey) {
            return -1;
          } else {
            return 1;
          }
        });

        const finalEntries = [];

        for (let i = 0; i < entries.length; i++) {
          const entry = entries[i];
          if (i == 0) {
            finalEntries.push(entry)
          } else {
            const lastEntry = entries[i - 1];
            if (lastEntry.endTime != entry.startTime) {
              // There is a gap, probably a reservation
              finalEntries.push({
                icon: "red x",
                description: "unknown reservation(s)",
                startTime: lastEntry.endTime,
                endTime: entry.startTime,
              });
            }

            finalEntries.push(entry);
          }

          if (i == entries.length - 1) {
            if (entry.endTime != "10:00 PM") {
              finalEntries.push({
                icon: "red x",
                description: "unknown reservation(s)",
                startTime: entry.endTime,
                endTime: "10:00 PM",
              });
            }
          }
        }

        return finalEntries;
      }, [unreservedData, securedData, park]);

      return (
        <>
          <h2 className="ui header">
            <i className="calendar alternate icon"></i>
            <div className="content">
              Calendar
              <div className="sub header">
                Query when courts are available for open play
              </div>
            </div>
          </h2>

          <div className={classnames(["ui basic segment"])}>
            <form className="ui form">
              <div className="two fields">

                <div className="field">
                  <label>park</label>
                  <div className="ui selection dropdown" ref={(ref) => {
                    $(ref).dropdown({
                      onChange: function(value) {
                        setPark(value);
                        updateQueryStringParameter("parkId", value);
                      }
                    });
                  }}>
                    <input type="hidden" name="parkId" value={park} />
                    <i className="dropdown icon"></i>
                    <div className="default text">park</div>
                    <div className="menu">
                      <div className="item" data-value="1374">Miller</div>
                      <div className="item" data-value="1378">Baker</div>
                      <div className="item" data-value="1319">Beacon Hill</div>
                    </div>
                  </div>
                </div>

                <div className="field">
                  <label>date</label>
                  <div className="ui input">
                    <input type="date" value={date} placeholder="Search..." onChange={(e) => {
                      setDate(e.target.value);
                      updateQueryStringParameter("date", e.target.value);
                    }} />
                  </div>
                </div>
              </div>
            </form>

            <div className={classnames(["ui", { loading: isLoading }, "basic segment"])}>

              {calendar.length == 0 && <div className="ui center aligned basic segment">No results found</div>}
              <div className="ui relaxed list">
                {calendar.map((entry) => {
                  return (<div key={entry.startTime} className="item">
                    <i className={`${entry.icon} icon`}></i>
                    <div className="content">
                      <div className="header">{entry.description}</div>
                      <div className="description">{entry.startTime} - {entry.endTime}</div>
                    </div>
                  </div>)
                })}
              </div>
            </div>
          </div>
        </>
      )
    };

    const TransactionsTab = () => {
      const [isLoading, setIsLoading] = React.useState(true);
      const [bookingsData, setBookingsData] = React.useState({});
      const [totalCost, setTotalCost] = React.useState(0);

      React.useEffect(() => {
        const db = window.firebaseApp.firestore();
        const transactionsRef = db.collection("transactions");

        transactionsRef.get().then((querySnapshot) => {
          const bookingsByDate = {};
          let totalCost = 0;

          querySnapshot.forEach((doc) => {
            const transactions = Object.values(doc.data());
            transactions.forEach((transaction) => {
              totalCost += transaction.totalCost;
              transaction.bookings.forEach((booking) => {
                const bookingDate = booking.startDateTime.substring(0, 10);
                bookingsByDate[bookingDate] ||= []
                bookingsByDate[bookingDate].push(booking);
              });
            });
          });

          setBookingsData(bookingsByDate);
          setTotalCost(totalCost)
          setIsLoading(false);
        });

      }, []);

      const dateFormat = "ddd, MMM Do";
      const timeFormat = "h:mma";

      const sortedBookingDates = Object.keys(bookingsData).sort();

      return (
        <>
          <h2 className="ui header">
            <i className="file alternate icon"></i>
            <div className="content">
              Reservations
              <div className="sub header">
                Table of all reservations made by zitnr for open play
              </div>
            </div>
          </h2>
          <div className={classnames(["ui", { loading: isLoading }, "very basic segment"])}>
            <table className="ui very basic table">
              <thead>
                <tr>
                  <th>date</th>
                  <th>times</th>
                  <th>cost</th>
                </tr>
              </thead>
              <tbody>
                {sortedBookingDates.map((bookingDate) => {
                  return (<tr key={bookingDate}>
                    <td className="collapsing">{moment(bookingDate).format(dateFormat)}</td>
                    <td>
                      {bookingsData[bookingDate].map((booking) => {
                        return (<div key={booking.startDateTime}>
                          {moment(booking.startDateTime).format(timeFormat)} - {moment(booking.endDateTime).format(timeFormat)}
                        </div>)
                      })}
                    </td>
                    <td className="collapsing">${bookingsData[bookingDate].reduce((total, booking) => {
                      return total + booking.cost;
                    }, 0).toFixed(2)}</td>
                  </tr>);
                })}
                <tr>
                  <td></td>
                  <td className="right aligned">
                    <strong>Total</strong>
                  </td>
                  <td><strong> ${totalCost.toFixed(2)}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </>
      )
    };


    const DonateTab = () => {
      const venmoUsername = "zack-do";
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const link = isMobile ? `venmo://users/${venmoUsername}` : `https://account.venmo.com/pay?recipients=${venmoUsername}`

      return (
        <>
          <h2 className="ui header">
            <i className="money bill alternate icon"></i>
            <div className="content">
              Donations
              <div className="sub header">
                Donations allow us to continue to reserve courts for open play
              </div>
            </div>
          </h2>
          <div className="ui center aligned basic segment">
            <img className="ui segment large centered image" src={`./${venmoUsername}-venmo.png`} />
            <a href={link} className="ui primary button">Venmo</a><br /><br />
          </div>
        </>
      );
    }

    const App = () => {
      const [selectedMenuItem, setSelectedMenuItem] = React.useState(window.location.hash);

      return <Menu selectedMenuItem={selectedMenuItem} setSelectedMenuItem={setSelectedMenuItem} />
    };

    const root = ReactDOM.createRoot(document.getElementById("root"))
    root.render(<App />);
  </script>
</body>

</html>
